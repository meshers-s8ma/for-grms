# Система отслеживания производственного процесса (Product Tracker)

Это веб-приложение на Flask, предназначенное для отслеживания прохождения изделий ("деталей") по производственным этапам с помощью QR-кодов. Система полностью контейнеризирована с помощью Docker и готова к развертыванию.

## Основной функционал

-   **Панель мониторинга:** Обзор состояния всех изделий и их прогресса в реальном времени с использованием WebSocket.
-   **Админ-панель:**
    -   Управление пользователями и ролями с гибкой настройкой прав доступа.
    -   Создание и редактирование технологических маршрутов и этапов.
    -   Добавление деталей вручную или массовым импортом из иерархических Excel/CSV файлов.
-   **QR-коды:** Генерация и печать QR-кодов для физической маркировки деталей.
-   **Отслеживание:** Страница сканирования для операторов для отметки о прохождении этапов.
-   **Интеграция с Microsoft Cloud:** Генерация Word-отчетов по шаблону на основе данных из Excel-файлов, хранящихся в OneDrive.
-   **Отчетность:** Визуальные отчеты (графики) по производительности операторов и длительности этапов.
-   **Аудит:** Ведение полного журнала всех действий пользователей в системе.

## Технологический стек

-   **Бэкенд:** Python 3.11, Flask, Flask-SocketIO
-   **База данных:** PostgreSQL
-   **ORM:** SQLAlchemy, Flask-Migrate (для управления миграциями)
-   **Фронтенд:** HTML, Tailwind CSS, JavaScript (Chart.js, SweetAlert2, Socket.io-client)
-   **Веб-сервер (Production):** Gunicorn + eventlet (для поддержки WebSocket)
-   **Тестирование:** Pytest
-   **Развертывание:** Docker, Docker Compose

---

## Предварительные требования

Для запуска проекта на вашей машине (локально или на сервере) необходимо установить:
-   [Docker](https://www.docker.com/get-started)
-   [Docker Compose](https://docs.docker.com/compose/install/)
-   [Node.js и npm](https://nodejs.org/en/download/) (требуется для сборки CSS)

---

## Конфигурация (`.env` файл)

Перед первым запуском необходимо создать конфигурационный файл `.env`.

1.  Скопируйте шаблон: `cp .env.example .env`
2.  Откройте файл `.env` и заполните все переменные.

### Описание переменных

#### Настройки Flask
-   `FLASK_ENV`: Режим работы. `development` для локальной разработки, `production` для сервера.
-   `FLASK_SECRET_KEY`: Надежный секретный ключ. Сгенерируйте командой `openssl rand -hex 32`.

#### Настройки PostgreSQL
-   `POSTGRES_DB`: Имя базы данных.
-   `POSTGRES_USER`: Имя пользователя базы данных.
-   `POSTGRES_PASSWORD`: Надежный пароль для пользователя.
-   `SQLALCHEMY_DATABASE_URI`: Строка подключения. Убедитесь, что пароль в ней совпадает с `POSTGRES_PASSWORD`.

#### Настройки сервера
-   `SERVER_PUBLIC_IP`: Публичный IP-адрес или домен вашего сервера. **Важно** для корректной генерации URL в QR-кодах. Для локальной разработки используйте IP-адрес вашего ПК в локальной сети (например, `192.168.1.10`) или `127.0.0.1`.
-   `SERVER_PORT`: Порт, который будет виден снаружи (например, `5000`).

#### Настройки логирования
-   `LOG_LEVEL`: Уровень логирования. `INFO` для production, `DEBUG` для разработки.

#### Интеграция с Microsoft Graph API (необязательно для базовой работы)
-   `MS_CLIENT_ID`: ID приложения (клиента) из Azure Active Directory.
-   `MS_CLIENT_SECRET`: Секрет клиента из Azure Active Directory.
-   `MS_TENANT_ID`: ID каталога (клиента) из Azure Active Directory.
-   `MS_ONEDRIVE_USER_ID`: Email или ID пользователя, чей OneDrive будет использоваться.

---

## Запуск проекта

### 1. Локальная разработка

Этот режим предназначен для разработки и тестирования на локальной машине. Он использует `docker-compose.yml`, который монтирует исходный код в контейнер, позволяя видеть изменения "на лету".

1.  **Установите npm-зависимости:**
    ```bash
    npm install
    ```
2.  **Создайте и заполните `.env` файл** (см. секцию "Конфигурация"). Установите `FLASK_ENV=development`.
3.  **Запустите Docker Compose:**
    ```bash
    docker-compose up --build
    ```
    Ключ `--build` необходим при первом запуске или после изменения зависимостей.
4.  **Первый запуск:** При первом запуске база данных будет создана автоматически.
5.  **Доступ к приложению:** Откройте в браузере `http://localhost:5000`.

Процесс `npm run dev` внутри контейнера будет автоматически отслеживать изменения в CSS и перезапускать Flask-сервер при изменениях в Python-коде.

### 2. Развертывание на Production-сервере

Этот режим использует `docker-compose.prod.yml` для создания оптимизированного и безопасного окружения.

1.  **Подключитесь к вашему серверу** (например, VPS с Ubuntu).
2.  **Установите Docker, Docker Compose и Node.js**, если их еще нет.
3.  **Скопируйте файлы проекта на сервер.**
4.  **Установите npm-зависимости и соберите CSS:**
    ```bash
    npm install
    npm run css:build
    ```
5.  **Создайте `.env` файл на сервере** из шаблона `.env.example`. **Критически важно:** используйте надежные, уникальные значения для `FLASK_SECRET_KEY` и `POSTGRES_PASSWORD`. Установите `FLASK_ENV=production`.
6.  **Соберите и запустите production-конфигурацию:**
    ```bash
    docker-compose -f docker-compose.prod.yml up --build -d
    ```
    Ключ `-d` запускает контейнеры в фоновом режиме.
7.  **Проверьте логи и сохраните пароль администратора:**
    -   Выполните `docker-compose -f docker-compose.prod.yml logs web`.
    -   При первом запуске будет выполнен `flask seed`, который создаст пользователя `admin` и сгенерирует для него случайный пароль. **Найдите и сохраните этот пароль в надежном месте.**
8.  **Приложение будет доступно** по адресу `http://<IP-адрес_вашего_сервера>:5000`.

---

## Тестирование

Для запуска автоматических тестов выполните команду внутри запущенного контейнера:

```bash
docker-compose exec web pytest