<!-- app/templates/history.html -->

{% extends "base.html" %}
{% from '_part_hierarchy.html' import render_children %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è: {{ part.part_id }}{% endblock %}

{% block content %}
<div class="mb-6">
    <div class="bg-gray-800 text-white p-4 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold">–û–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ: {{ part.part_id }}</h1>
        <p class="text-lg text-gray-300 mt-1">–ò–∑–¥–µ–ª–∏–µ: <span class="font-medium">{{ part.product_designation }}</span></p>
        <div class="mt-2 text-sm text-gray-400 grid grid-cols-1 sm:grid-cols-2 gap-x-4">
            <p>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: <span class="font-medium text-gray-200">{{ part.name }}</span></p>
            <p>–ú–∞—Ç–µ—Ä–∏–∞–ª: <span class="font-medium text-gray-200">{{ part.material }}</span></p>
        </div>
    </div>
</div>

<!-- –ü–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –∏ –¥–µ–π—Å—Ç–≤–∏–π —Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–º –¥–ª—è –≥–∞–ª–µ—Ä–µ–∏ -->
<div id="drawing-container" class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-wrap gap-4 items-center justify-between">
    <div>
        {% if part.parent %}
            <a href="{{ url_for('main.history', part_id=part.parent.part_id) }}" class="text-blue-600 hover:underline">&larr; –ù–∞–∑–∞–¥ –∫ {{ part.parent.name }}</a>
        {% else %}
            <a href="{{ url_for('main.dashboard') }}" class="text-blue-600 hover:underline">&larr; –ù–∞–∑–∞–¥ –Ω–∞ –ø–∞–Ω–µ–ª—å</a>
        {% endif %}
    </div>
    <div class="flex flex-wrap gap-4 items-center">
        {% if part.drawing_filename %}
            <!-- –≠—Ç–∞ —Å—Å—ã–ª–∫–∞ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞ lightgallery.js -->
            <a href="{{ url_for('admin.part.serve_drawing', filename=part.drawing_filename) }}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-md">
                –ü–æ–∫–∞–∑–∞—Ç—å —á–µ—Ä—Ç–µ–∂
            </a>
        {% endif %}
        
        {% if current_user.is_authenticated and current_user.can(Permission.EDIT_PARTS) %}
            <a href="{{ url_for('admin.part.change_part_route', part_id=part.part_id) }}" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md">
                –°–º–µ–Ω–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç
            </a>
            <a href="{{ url_for('admin.part.change_responsible', part_id=part.part_id) }}" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-md">
                –°–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ
            </a>
        {% endif %}
    </div>
</div>

<!-- –ë–ª–æ–∫ –∏–µ—Ä–∞—Ä—Ö–∏–∏ –∏–∑–¥–µ–ª–∏—è -->
<div class="mb-8">
    <h2 class="text-2xl font-semibold text-gray-800 mb-4">–°–æ—Å—Ç–∞–≤ –∏–∑–¥–µ–ª–∏—è</h2>
    <div class="bg-white p-6 rounded-lg shadow-md">
        {% if part.parent %}
        <div class="mb-4">
            <span class="text-gray-500">–í—Ö–æ–¥–∏—Ç –≤ —Å–æ—Å—Ç–∞–≤:</span>
            <a href="{{ url_for('main.history', part_id=part.parent.part_id) }}" class="font-medium text-blue-600 hover:underline">{{ part.parent.name }} ({{ part.parent.part_id }})</a>
        </div>
        {% endif %}

        <h3 class="font-semibold text-gray-700 mb-2">–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã ({{ part.children.count() }}):</h3>
        {% if part.children.count() > 0 %}
            <!-- --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–Ø: –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–∞–∫—Ä–æ—Å –¥–ª—è —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è --- -->
            <div class="ml-4">
                {{ render_children(part.children.order_by('name')) }}
            </div>
            <!-- --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø --- -->
        {% else %}
            <p class="text-sm text-gray-500 italic">–í —Å–æ—Å—Ç–∞–≤–µ —ç—Ç–æ–≥–æ —É–∑–ª–∞ –Ω–µ—Ç –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.</p>
        {% endif %}

        {% if current_user.is_authenticated and current_user.can(Permission.ADD_PARTS) %}
        <div class="mt-6 pt-6 border-t border-gray-200">
            <h3 class="font-semibold text-gray-700 mb-4">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —É–∑–µ–ª/–∫–æ–º–ø–æ–Ω–µ–Ω—Ç –≤ —Å–æ—Å—Ç–∞–≤</h3>
            <form action="{{ url_for('admin.part.add_child_part', parent_part_id=part.part_id) }}" method="post" novalidate class="space-y-4">
                {{ child_form.hidden_tag() }}
                <div>
                    {{ child_form.part_id.label(class="block text-sm font-medium text-gray-700") }}
                    {{ child_form.part_id(class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500") }}
                </div>
                <!-- --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–Ø: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–º—è –ø–æ–ª—è –Ω–∞ `name` --- -->
                <div>
                    {{ child_form.name.label(class="block text-sm font-medium text-gray-700") }}
                    {{ child_form.name(class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500") }}
                </div>
                <!-- --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø --- -->
                <div>
                    {{ child_form.material.label(class="block text-sm font-medium text-gray-700") }}
                    {{ child_form.material(class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500") }}
                </div>
                <div>
                    {{ child_form.quantity_total.label(class="block text-sm font-medium text-gray-700") }}
                    {{ child_form.quantity_total(class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500", type="number", min="1") }}
                </div>
                {{ child_form.submit(class="inline-flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500") }}
            </form>
        </div>
        {% endif %}
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Å–µ—Ç–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ—á–∞–Ω–∏–π –∏ –ª–µ–Ω—Ç—ã —Å–æ–±—ã—Ç–∏–π -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –§–æ—Ä–º–∞ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è -->
    <div class="lg:col-span-1">
        {% if current_user.is_authenticated %}
        <div class="bg-white p-6 rounded-lg shadow-md sticky top-10">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ</h2>
            <form action="{{ url_for('main.add_note', part_id=part.part_id) }}" method="post" novalidate class="space-y-4">
                {{ note_form.hidden_tag() }}
                <div>
                    {{ note_form.stage.label(class="block text-sm font-medium text-gray-700") }}
                    {{ note_form.stage(class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md") }}
                </div>
                <div>
                    {{ note_form.text.label(class="block text-sm font-medium text-gray-700") }}
                    {{ note_form.text(rows=4, class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500") }}
                    {% for error in note_form.text.errors %}<p class="mt-2 text-sm text-red-600">{{ error }}</p>{% endfor %}
                </div>
                {{ note_form.submit(class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500") }}
            </form>
        </div>
        {% endif %}
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –õ–µ–Ω—Ç–∞ —Å–æ–±—ã—Ç–∏–π -->
    <div class="lg:col-span-2">
        <div class="space-y-6">
            {% if combined_history %}
                {% for entry in combined_history %}
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        {% if entry.type == 'status' %}
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-gray-800">{{ entry.status }}</p>
                                    <p class="text-sm text-gray-600">–í—ã–ø–æ–ª–Ω–µ–Ω–æ: {{ entry.quantity }} —à—Ç.</p>
                                    <p class="text-sm text-gray-500">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {{ entry.operator_name }}</p>
                                </div>
                                <div class="text-right flex-shrink-0 ml-4">
                                    <p class="text-xs text-gray-500">{{ entry.timestamp.strftime('%d.%m.%Y') }}</p>
                                    <p class="text-xs text-gray-500">{{ entry.timestamp.strftime('%H:%M:%S') }}</p>
                                    {% if current_user.is_authenticated and current_user.can(Permission.EDIT_PARTS) %}
                                    <form action="{{ url_for('admin.part.cancel_stage', history_id=entry.id) }}" method='post' class="form-confirm mt-2" data-text="–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å —ç—Ç–∞–ø '{{ entry.status }}' ({{ entry.quantity }} —à—Ç.)?">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type='submit' class='text-red-500 hover:text-red-700 text-xs font-semibold'>–û—Ç–º–µ–Ω–∏—Ç—å</button>
                                    </form>
                                    {% endif %}
                                </div>
                            </div>
                        {% elif entry.type == 'audit' %}
                            <div class="flex justify-between items-start opacity-70">
                                <div>
                                    <p class="font-semibold text-gray-600">‚öô {{ entry.action }}</p>
                                    <p class="text-sm text-gray-500 italic">"{{ entry.details }}"</p>
                                    <p class="text-sm text-gray-500">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {% if entry.user %}{{ entry.user.username }}{% endif %}</p>
                                </div>
                                <div class="text-right flex-shrink-0 ml-4">
                                    <p class="text-xs text-gray-500">{{ entry.timestamp.strftime('%d.%m.%Y') }}</p>
                                    <p class="text-xs text-gray-500">{{ entry.timestamp.strftime('%H:%M:%S') }}</p>
                                </div>
                            </div>
                        {% elif entry.type == 'responsible' %}
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded-md flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-blue-800">üë§ {{ entry.action }}</p>
                                    <p class="text-sm text-gray-700 mt-1">
                                        –ù–æ–≤—ã–π –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: <strong>{{ entry.user.username if entry.user else '–°–Ω—è—Ç–æ' }}</strong>
                                    </p>
                                </div>
                                <div class="text-right flex-shrink-0 ml-4">
                                    <p class="text-xs text-gray-500">{{ entry.timestamp.strftime('%d.%m.%Y') }}</p>
                                    <p class="text-xs text-gray-500">{{ entry.timestamp.strftime('%H:%M:%S') }}</p>
                                </div>
                            </div>
                        {% elif entry.type == 'note' %}
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-md">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <p class="font-semibold text-yellow-800">üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ {% if entry.stage %} –∫ —ç—Ç–∞–ø—É "{{ entry.stage.name }}"{% endif %}</p>
                                        <div class="text-sm text-gray-700 mt-2 prose max-w-none" id="note-text-{{ entry.id }}">{{ entry.text|nl2br }}</div>
                                        <div id="note-edit-form-{{ entry.id }}" style="display: none;">
                                            <!-- --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–Ø: –§–æ—Ä–º–∞ —Ç–µ–ø–µ—Ä—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS --- -->
                                            <form class="mt-2 note-edit-form" data-note-id="{{ entry.id }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <textarea name="text" rows="3" class="w-full border border-gray-300 rounded-md p-2">{{ entry.text }}</textarea>
                                                <div class="mt-2 space-x-2">
                                                    <button type="submit" class="bg-blue-600 text-white px-3 py-1 text-sm rounded-md">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                                    <button type="button" class="bg-gray-200 text-gray-700 px-3 py-1 text-sm rounded-md" onclick="toggleEdit({{ entry.id }})">–û—Ç–º–µ–Ω–∞</button>
                                                </div>
                                            </form>
                                            <!-- --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø --- -->
                                        </div>
                                        <p class="text-sm text-gray-500 mt-2">–ê–≤—Ç–æ—Ä: {% if entry.author %}{{ entry.author.username }}{% endif %}</p>
                                    </div>
                                    <div class="text-right flex-shrink-0 ml-4">
                                        <p class="text-xs text-gray-500">{{ entry.timestamp.strftime('%d.%m.%Y') }}</p>
                                        <p class="text-xs text-gray-500">{{ entry.timestamp.strftime('%H:%M:%S') }}</p>
                                        {% if current_user.is_authenticated and (entry.author and entry.author.id == current_user.id or current_user.is_admin()) %}
                                        <div class="mt-2 space-x-2">
                                            <button class="text-blue-600 hover:text-blue-800 text-xs font-semibold" onclick="toggleEdit({{ entry.id }})">–†–µ–¥.</button>
                                            <form action="{{ url_for('main.delete_note', note_id=entry.id) }}" method="post" class="inline form-confirm" data-text="–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ?">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="text-red-500 hover:text-red-700 text-xs font-semibold">–£–¥–∞–ª.</button>
                                            </form>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <div class="bg-white p-6 rounded-lg shadow-md text-center text-gray-500">
                    <p>–ò—Å—Ç–æ—Ä–∏—è –¥–ª—è —ç—Ç–æ–π –¥–µ—Ç–∞–ª–∏ –ø—É—Å—Ç–∞.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- --- –ù–ê–ß–ê–õ–û –ò–ó–ú–ï–ù–ï–ù–ò–Ø: –ù–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è AJAX-—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è --- -->
<script>
    function toggleEdit(noteId) {
        const textDiv = document.getElementById('note-text-' + noteId);
        const formDiv = document.getElementById('note-edit-form-' + noteId);
        if (textDiv && formDiv) {
            textDiv.style.display = textDiv.style.display === 'none' ? 'block' : 'none';
            formDiv.style.display = formDiv.style.display === 'none' ? 'block' : 'none';
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.note-edit-form').forEach(form => {
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                const noteId = this.dataset.noteId;
                const formData = new FormData(this);
                const textDiv = document.getElementById('note-text-' + noteId);
                
                try {
                    const response = await fetch(`/edit_note/${noteId}`, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    
                    if (response.ok) {
                        // –ó–∞–º–µ–Ω—è–µ–º HTML-—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ nl2br
                        const newHtml = result.new_text.replace(/\n/g, '<br>\n');
                        textDiv.innerHTML = `<p>${newHtml}</p>`;
                        toggleEdit(noteId);
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "—Ç–æ—Å—Ç" –æ–± —É—Å–ø–µ—Ö–µ
                        createToast(result.message, 'success');
                    } else {
                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "—Ç–æ—Å—Ç" –æ–± –æ—à–∏–±–∫–µ
                        createToast(result.message || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
                    }
                } catch (error) {
                    createToast('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
                }
            });
        });
    });
</script>
<!-- --- –ö–û–ù–ï–¶ –ò–ó–ú–ï–ù–ï–ù–ò–Ø --- -->

<script>
document.addEventListener('DOMContentLoaded', function() {
    const drawingContainer = document.getElementById('drawing-container');
    if (drawingContainer) {
        lightGallery(drawingContainer, {
            selector: 'a[href$=".jpg"], a[href$=".jpeg"], a[href$=".png"], a[href$=".gif"]',
            download: false,
            licenseKey: '0000-0000-000-0000'
        });
    }
});
</script>
{% endblock %}